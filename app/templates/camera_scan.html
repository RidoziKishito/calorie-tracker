{% extends "base.html" %}

{% block title %}Quét món ăn{% endblock %}

{% block main_class %}p-0 w-100 h-100 overflow-hidden bg-black{% endblock %}

{% block content %}
<div class="position-relative w-100 h-100" style="min-height: 100vh;">
    <!-- Video Feed -->
    <video id="video" class="w-100 h-100 object-fit-cover" autoplay playsinline muted></video>
    <canvas id="canvas" class="d-none"></canvas>

    <!-- Overlay UI -->
    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-between p-4 z-2">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center text-white">
            <a href="/home/dashboard" class="btn btn-dark bg-opacity-50 rounded-circle text-white shadow-sm"
                style="width: 40px; height: 40px; display: grid; place-items: center;">
                <i class="fa-solid fa-xmark"></i>
            </a>
            <span class="bg-dark bg-opacity-50 px-3 py-1 rounded-pill small fw-bold backdrop-blur">AI Food
                Scanner</span>
            <button class="btn btn-dark bg-opacity-50 rounded-circle text-white shadow-sm" onclick="switchCamera()"
                style="width: 40px; height: 40px; display: grid; place-items: center;">
                <i class="fa-solid fa-camera-rotate"></i>
            </button>
        </div>

        <!-- Scanning Frame -->
        <div class="flex-grow-1 d-flex flex-column justify-content-center align-items-center">
            <div class="scan-frame position-relative" style="width: 280px; height: 280px;">
                <div class="corner topleft"></div>
                <div class="corner topright"></div>
                <div class="corner bottomleft"></div>
                <div class="corner bottomright"></div>
                <!-- Scanning Line Animation -->
                <div class="scan-line"></div>
            </div>
            <p class="text-white text-center mt-3 text-shadow small opacity-75">Di chuyển camera vào món ăn</p>
        </div>

        <!-- Controls -->
        <div class="d-flex justify-content-between align-items-center mb-5 pb-3 px-3">
            <!-- Upload Button -->
            <label for="fileInput"
                class="btn btn-dark bg-opacity-50 rounded-circle text-white shadow-sm d-flex align-items-center justify-content-center border-0"
                style="width: 48px; height: 48px;">
                <i class="fa-solid fa-image"></i>
                <input type="file" id="fileInput" accept="image/*" class="d-none" onchange="handleFileUpload(this)">
            </label>

            <!-- Capture Button -->
            <button id="captureBtn"
                class="shutter-btn border-4 border-white rounded-circle bg-transparent d-flex align-items-center justify-content-center"
                style="width: 80px; height: 80px; padding: 4px;">
                <span class="d-block bg-white rounded-circle hover-scale"
                    style="width: calc(100% - 8px); height: calc(100% - 8px);"></span>
            </button>

            <!-- Spacer to balance -->
            <a href="/home/manual_input"
                class="btn btn-dark bg-opacity-50 rounded-circle text-white shadow-sm d-flex align-items-center justify-content-center border-0"
                style="width: 48px; height: 48px;">
                <i class="fa-solid fa-magnifying-glass"></i>
            </a>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="position-absolute top-0 start-0 w-100 h-100 bg-black bg-opacity-75 d-flex flex-column justify-content-center align-items-center z-3 d-none">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="text-white mt-3 fw-bold">Đang phân tích...</p>
    </div>
</div>

<style>
    .scan-frame .corner {
        position: absolute;
        width: 30px;
        height: 30px;
        border: 4px solid white;
        border-radius: 4px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }

    .scan-frame .topleft {
        top: 0;
        left: 0;
        border-right: none;
        border-bottom: none;
    }

    .scan-frame .topright {
        top: 0;
        right: 0;
        border-left: none;
        border-bottom: none;
    }

    .scan-frame .bottomleft {
        bottom: 0;
        left: 0;
        border-right: none;
        border-top: none;
    }

    .scan-frame .bottomright {
        bottom: 0;
        right: 0;
        border-left: none;
        border-top: none;
    }

    .scan-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: var(--primary-color, #10B981);
        box-shadow: 0 0 10px var(--primary-color, #10B981);
        animation: scan 2s linear infinite;
        opacity: 0.6;
    }

    @keyframes scan {
        0% {
            top: 10%;
            opacity: 0;
        }

        10% {
            opacity: 0.8;
        }

        90% {
            opacity: 0.8;
        }

        100% {
            top: 90%;
            opacity: 0;
        }
    }

    .shutter-btn:active span {
        transform: scale(0.9);
        background-color: #ddd;
    }

    .text-shadow {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }

    .backdrop-blur {
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }
</style>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    let stream = null;
    let facingMode = 'environment'; // Start with back camera

    async function startCamera() {
        try {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;

        } catch (err) {
            console.error("Error accessing camera:", err);
            alert("Không thể truy cập camera. Vui lòng cho phép quyền truy cập hoặc sử dụng tính năng tải ảnh lên.");
        }
    }

    function switchCamera() {
        facingMode = facingMode === 'user' ? 'environment' : 'user';
        startCamera();
    }

    captureBtn.addEventListener('click', () => {
        // Show loading
        loadingOverlay.classList.remove('d-none');

        // Setup canvas
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Draw video frame to canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Convert to blob and send
        canvas.toBlob(blob => {
            uploadImage(blob);
        }, 'image/jpeg', 0.85);
    });

    function handleFileUpload(input) {
        if (input.files && input.files[0]) {
            loadingOverlay.classList.remove('d-none');
            uploadImage(input.files[0]);
        }
    }

    function uploadImage(file) {
        const formData = new FormData();
        formData.append('file', file, 'capture.jpg');

        fetch('/camera/result', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Network response was not ok');
            })
            .then(html => {
                // Replace document content with result page (simplest way to navigate with POST result)
                document.open();
                document.write(html);
                document.close();

                // Stop camera
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            })
            .catch(error => {
                console.error('Error:', error);
                loadingOverlay.classList.add('d-none');
                alert('Có lỗi xảy ra khi xử lý ảnh. Vui lòng thử lại.');
            });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', startCamera);

    // Clean up on exit
    window.addEventListener('beforeunload', () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
</script>
{% endblock %}